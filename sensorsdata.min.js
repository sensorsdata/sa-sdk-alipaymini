import conf from"./sensorsdata_conf.js";var sa={},_={};sa.para=conf,sa.para.max_string_length=sa.para.max_string_length||200,sa._queue=[],sa.getSystemInfoComplete=!1;var ArrayProto=Array.prototype,FuncProto=Function.prototype,ObjProto=Object.prototype,slice=ArrayProto.slice,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty,LIB_VERSION="1.0.10",LIB_NAME="AlipayMini",source_channel_standard="utm_source utm_medium utm_campaign utm_content utm_term",sa_referrer="\u76f4\u63a5\u6253\u5f00";sa.lib_version=LIB_VERSION;var is_first_launch=!1,mpshow_time=null,logger="object"==typeof logger?logger:{};logger.info=function(){if("object"==typeof console&&console.log)try{return console.log.apply(console,arguments)}catch(e){console.log(arguments[0])}},function(){FuncProto.bind;var e=ArrayProto.forEach,t=ArrayProto.indexOf,r=Array.isArray,n={},i=_.each=function(t,r,i){if(null==t)return!1;if(e&&t.forEach===e)t.forEach(r,i);else if(t.length===+t.length){for(var s=0,a=t.length;s<a;s++)if(s in t&&r.call(i,t[s],s,t)===n)return!1}else for(var o in t)if(hasOwnProperty.call(t,o)&&r.call(i,t[o],o,t)===n)return!1};_.logger=logger,_.extend=function(e){return i(slice.call(arguments,1),function(t){for(var r in t)void 0!==t[r]&&(e[r]=t[r])}),e},_.extend2Lev=function(e){return i(slice.call(arguments,1),function(t){for(var r in t)void 0!==t[r]&&null!==t[r]&&(_.isObject(t[r])&&_.isObject(e[r])?_.extend(e[r],t[r]):e[r]=t[r])}),e},_.coverExtend=function(e){return i(slice.call(arguments,1),function(t){for(var r in t)void 0!==t[r]&&void 0===e[r]&&(e[r]=t[r])}),e},_.isArray=r||function(e){return"[object Array]"===toString.call(e)},_.isFunction=function(e){try{return/^\s*\bfunction\b/.test(e)}catch(e){return!1}},_.isArguments=function(e){return!(!e||!hasOwnProperty.call(e,"callee"))},_.toArray=function(e){return e?e.toArray?e.toArray():_.isArray(e)?slice.call(e):_.isArguments(e)?slice.call(e):_.values(e):[]},_.values=function(e){var t=[];return null==e?t:(i(e,function(e){t[t.length]=e}),t)},_.include=function(e,r){var s=!1;return null==e?s:t&&e.indexOf===t?-1!=e.indexOf(r):(i(e,function(e){if(s||(s=e===r))return n}),s)}}(),_.trim=function(e){return e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},_.isObject=function(e){return"[object Object]"==toString.call(e)&&null!=e},_.isEmptyObject=function(e){if(_.isObject(e)){for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0}return!1},_.isUndefined=function(e){return void 0===e},_.isString=function(e){return"[object String]"==toString.call(e)},_.isDate=function(e){return"[object Date]"==toString.call(e)},_.isBoolean=function(e){return"[object Boolean]"==toString.call(e)},_.isNumber=function(e){return"[object Number]"==toString.call(e)&&/[\d\.]+/.test(String(e))},_.isJSONString=function(e){try{JSON.parse(e)}catch(e){return!1}return!0},_.decodeURIComponent=function(e){var t="";try{t=decodeURIComponent(e)}catch(r){t=e}return t},_.encodeDates=function(e){return _.each(e,function(t,r){_.isDate(t)?e[r]=_.formatDate(t):_.isObject(t)&&(e[r]=_.encodeDates(t))}),e},_.formatDate=function(e){function t(e){return e<10?"0"+e:e}return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+t(e.getMilliseconds())},_.searchObjDate=function(e){_.isObject(e)&&_.each(e,function(t,r){_.isObject(t)?_.searchObjDate(e[r]):_.isDate(t)&&(e[r]=_.formatDate(t))})},_.formatString=function(e){return e.length>sa.para.max_string_length?(logger.info("\u5b57\u7b26\u4e32\u957f\u5ea6\u8d85\u8fc7\u9650\u5236\uff0c\u5df2\u7ecf\u505a\u622a\u53d6--"+e),e.slice(0,sa.para.max_string_length)):e},_.searchObjString=function(e){_.isObject(e)&&_.each(e,function(t,r){_.isObject(t)?_.searchObjString(e[r]):_.isString(t)&&(e[r]=_.formatString(t))})},_.unique=function(e){for(var t,r=[],n={},i=0;i<e.length;i++)(t=e[i])in n||(n[t]=!0,r.push(t));return r},_.strip_sa_properties=function(e){return _.isObject(e)?(_.each(e,function(t,r){if(_.isArray(t)){var n=[];_.each(t,function(e){_.isString(e)?n.push(e):logger.info("\u60a8\u7684\u6570\u636e-",t,"\u7684\u6570\u7ec4\u91cc\u7684\u503c\u5fc5\u987b\u662f\u5b57\u7b26\u4e32,\u5df2\u7ecf\u5c06\u5176\u5220\u9664")}),0!==n.length?e[r]=n:(delete e[r],logger.info("\u5df2\u7ecf\u5220\u9664\u7a7a\u7684\u6570\u7ec4"))}_.isString(t)||_.isNumber(t)||_.isDate(t)||_.isBoolean(t)||_.isArray(t)||(logger.info("\u60a8\u7684\u6570\u636e-",t,"-\u683c\u5f0f\u4e0d\u6ee1\u8db3\u8981\u6c42\uff0c\u6211\u4eec\u5df2\u7ecf\u5c06\u5176\u5220\u9664"),delete e[r])}),e):e},_.strip_empty_properties=function(e){var t={};return _.each(e,function(e,r){null!=e&&(t[r]=e)}),t},_.utf8Encode=function(e){var t,r,n,i,s="";for(t=r=0,n=(e=(e+"").replace(/\r\n/g,"\n").replace(/\r/g,"\n")).length,i=0;i<n;i++){var a=e.charCodeAt(i),o=null;a<128?r++:o=a>127&&a<2048?String.fromCharCode(a>>6|192,63&a|128):String.fromCharCode(a>>12|224,a>>6&63|128,63&a|128),null!==o&&(r>t&&(s+=e.substring(t,r)),s+=o,t=r=i+1)}return r>t&&(s+=e.substring(t,e.length)),s},_.base64Encode=function(e){var t,r,n,i,s,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o=0,c=0,u="",p=[];if(!e)return e;e=_.utf8Encode(e);do{t=(s=e.charCodeAt(o++)<<16|e.charCodeAt(o++)<<8|e.charCodeAt(o++))>>18&63,r=s>>12&63,n=s>>6&63,i=63&s,p[c++]=a.charAt(t)+a.charAt(r)+a.charAt(n)+a.charAt(i)}while(o<e.length);switch(u=p.join(""),e.length%3){case 1:u=u.slice(0,-2)+"==";break;case 2:u=u.slice(0,-1)+"="}return u},_.info={currentProps:{},properties:{$lib:LIB_NAME,$lib_version:String(LIB_VERSION)},getSystem:function(){var e=this.properties,t=!0;function r(){t&&(t=!0,my.getSystemInfo({success:function(t){var r,n;e.$model=t.model,e.$screen_width=Number(t.screenWidth),e.$screen_height=Number(t.screenHeight),e.$os=(r=t.platform,"ios"===(n=r.toLowerCase())?"iOS":"android"===n?"Android":r),e.$os_version=t.system.indexOf(" ")>-1?t.system.split(" ")[1]:t.system,e.$manufacturer=t.brand},complete:function(){sa.getSystemInfoComplete=!0,sa.checkIsComplete()}}))}my.getNetworkType({success:function(t){e.$network_type=t.networkType,r()},complete:function(){r()}})},setStatusComplete:function(){if(sa.getSystemInfoComplete)return!1;sa.getSystemInfoComplete=!0,sa._queue.length>0&&(_.each(sa._queue,function(e){sa.prepareData.apply(sa,slice.call(e))}),sa._queue=[])}},sa._=_,sa.prepareData=function(e,t){if(!sa.isComplete)return sa._queue.push(arguments),!1;var r={distinct_id:this.store.getDistinctId(),lib:{$lib:LIB_NAME,$lib_method:"code",$lib_version:String(LIB_VERSION)},properties:{}};_.extend(r,e),_.isObject(e.properties)&&!_.isEmptyObject(e.properties)&&_.extend(r.properties,e.properties),e.type&&"profile"===e.type.slice(0,7)||(r.properties=_.extend({},_.info.properties,sa.store.getProps(),_.info.currentProps,r.properties),"object"==typeof sa.store._state&&"number"==typeof sa.store._state.first_visit_day_time&&sa.store._state.first_visit_day_time>(new Date).getTime()?r.properties.$is_first_day=!0:r.properties.$is_first_day=!1),r.properties.$time&&_.isDate(r.properties.$time)?(r.time=1*r.properties.$time,delete r.properties.$time):r.time=1*new Date,_.searchObjDate(r),_.searchObjString(r),sa.send(r,t)},sa.checkIsComplete=function(){this.isComplete=!1,this.getSystemInfoComplete&&this.hasInit&&(this.isComplete=!0,sa._queue.length>0&&(_.each(sa._queue,function(e){sa.prepareData.apply(sa,slice.call(e))}),sa._queue=[]))},sa.store={getUUID:function(){return Date.now()+"-"+Math.floor(1e7*Math.random())+"-"+Math.random().toString(16).replace(".","")+"-"+String(31242*Math.random()).replace(".","").slice(0,8)},setStorage:function(){},getStorage:function(){return my.getStorageSync({key:"sensorsdata2015_zfb"})||{}},_state:{},toState:function(e){"object"==typeof e&&e.distinct_id?this._state=e:this.set("distinct_id",this.getUUID())},getFirstId:function(){return this._state.first_id},getDistinctId:function(){return this._state.distinct_id},getProps:function(){return this._state.props||{}},setProps:function(e,t){var r=this._state.props||{};t?this.set("props",e):(_.extend(r,e),this.set("props",r))},set:function(e,t){var r={};for(var n in"string"==typeof e?r[e]=t:"object"==typeof e&&(r=e),this._state=this._state||{},r)this._state[n]=r[n];this.save()},change:function(e,t){this._state[e]=t},save:function(){my.setStorageSync({key:"sensorsdata2015_zfb",data:this._state})},init:function(){var e=this.getStorage().data;if(e)this.toState(e);else{is_first_launch=!0;var t=new Date,r=t.getTime();t.setHours(23),t.setMinutes(59),t.setSeconds(60),this.set({distinct_id:this.getUUID(),first_visit_time:r,first_visit_day_time:t.getTime()})}}},sa.setProfile=function(e,t){sa.prepareData({type:"profile_set",properties:e},t)},sa.setOnceProfile=function(e,t){sa.prepareData({type:"profile_set_once",properties:e},t)},sa.track=function(e,t,r){this.prepareData({type:"track",event:e,properties:t},r)},sa.identify=function(e,t){if("number"==typeof e)e=String(e);else if("string"!=typeof e)return!1;var r=sa.store.getFirstId();!0===t?r?sa.store.set("first_id",e):sa.store.set("distinct_id",e):r?sa.store.change("first_id",e):sa.store.change("distinct_id",e)},sa.trackSignup=function(e,t,r,n){var i=sa.store.getFirstId()||sa.store.getDistinctId();sa.store.set("distinct_id",e),sa.prepareData({original_id:i,distinct_id:e,type:"track_signup",event:t,properties:r},n)},sa.registerApp=function(e){_.isObject(e)&&!_.isEmptyObject(e)&&(_.info.currentProps=_.extend(_.info.currentProps,e))},sa.clearAllRegister=function(){sa.store.setProps({},!0)},sa.login=function(e){var t=sa.store.getFirstId(),r=sa.store.getDistinctId();e!==r&&(t?sa.trackSignup(e,"$SignUp"):(sa.store.set("first_id",r),sa.trackSignup(e,"$SignUp")))},sa.logout=function(e){var t=sa.store.getFirstId();t?(sa.store.set("first_id",""),!0===e?sa.store.set("distinct_id",sa.store.getUUID()):sa.store.set("distinct_id",t)):logger.info("\u6ca1\u6709first_id\uff0clogout\u5931\u8d25")},sa.initial=function(){this._.info.getSystem(),this.store.init(),_.isObject(this.para.register)&&(_.info.properties=_.extend(_.info.properties,this.para.register))},sa.init=function(){if(!0===this.hasInit)return!1;this.hasInit=!0,sa.checkIsComplete()},sa.send=function(e){var t="";e._nocache=(String(Math.random())+String(Math.random())+String(Math.random())).slice(2,15),logger.info(e),e=JSON.stringify(e),t=-1!==sa.para.server_url.indexOf("?")?sa.para.server_url+"&data="+encodeURIComponent(_.base64Encode(e)):sa.para.server_url+"?data="+encodeURIComponent(_.base64Encode(e));my.canIUse("request")?my.request({url:t,dataType:"text",method:"GET",headers:{"content-type":"application/x-www-form-urlencoded"}}):my.httpRequest({url:t,dataType:"text",method:"GET"})},_.getPath=function(e){return e="string"==typeof e?e.replace(/^\//,""):"\u53d6\u503c\u5f02\u5e38"},_.getQueryParam=function(e,t){var r=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(e);return null===r||r&&"string"!=typeof r[1]&&r[1].length?"":_.decodeURIComponent(r[1])},_.getMPScene=function(e){return"number"==typeof e||"string"==typeof e&&""!==e?e=String(e):""},_.setUtm=function(e,t){var r={};if(e&&_.isObject(e.query)&&(r=_.extend({},e.query),e.query.qrCode&&_.extend(r,_.getObjFromQuery(_.decodeURIComponent(e.query.qrCode)))),e&&_.isObject(e.referrerInfo)&&e.referrerInfo.extraData){var n={};_.isObject(e.referrerInfo.extraData)&&!_.isEmptyObject(e.referrerInfo.extraData)?n=e.referrerInfo.extraData:_.isJSONString(e.referrerInfo.extraData)&&(n=JSON.parse(e.referrerInfo.extraData)),_.extend(r,n)}var i=_.getUtm(r,"$","$latest_");return _.extend(t,i.pre1),i},_.getObjFromQuery=function(e){var t=e.split("?"),r={};return t&&t[1]?(_.each(t[1].split("&"),function(e){var t=e.split("=");t[0]&&t[1]&&(r[t[0]]=t[1])}),r):{}},_.getUtm=function(e,t,r){var n=_.getSource(e);return void 0===r&&t?{pre1:_.getPrefixUtm(n,t).$utms||{},pre2:{}}:void 0!==r&&t?{pre1:_.getPrefixUtm(n,t).$utms||{},pre2:_.getPrefixUtm(n,r).$utms||{}}:{pre1:{},pre2:{}}},_.getPrefixUtm=function(e,t,r){if(t=t||"",r=r||"_",!_.isObject(e))return{};var n={},i={};for(var s in e)-1!==(" "+source_channel_standard+" ").indexOf(" "+s+" ")?n[t+s]=e[s]:i[r+s]=e[s];return{$utms:n,otherUtms:i}},_.convertObjToParam=function(e){var t=[];for(var r in e)t.push(r+"="+e[r]);return t.join("&")},_.getSource=function(e){if(_.isObject(e)){if(_.isEmptyObject(e))return{};for(var t in e)-1===(" "+source_channel_standard+" ").indexOf(" "+t+" ")?delete e[t]:e[t]=e[t].replace("?","*");e="?"+(e=_.convertObjToParam(e))}else e=_.decodeURIComponent(e);var r=source_channel_standard.split(" "),n=source_channel_standard.split(" "),i="",s={};return 2!==(e=e.split("?")).length?{}:(e="?"+(e=e[1]),_.isArray(sa.para.source_channel)&&sa.para.source_channel.length>0&&(n=n.concat(sa.para.source_channel),n=_.unique(n)),_.each(n,function(t){i=_.getQueryParam(e,t),(i=_.decodeURIComponent(i)).length&&_.include(r,t)&&(s[t]=i)}),s)},_.setQuery=function(e){if(e&&_.isObject(e)&&!_.isEmptyObject(e)){var t=[];return _.each(e,function(e,r){"q"===r&&_.isString(e)&&0===e.indexOf("http")||"scene"===r||t.push(r+"="+e)}),t.join("&")}return""},_.getCurrentPath=function(){var e="\u672a\u53d6\u5230";try{var t=getCurrentPages();e=t[t.length-1].route}catch(e){logger.info(e)}return e},sa.appLaunch=function(e,t){t&&_.isObject(t)||(t={});var r={};e&&e.path&&(r.$url_path=_.getPath(e.path));var n=_.setUtm(e,r);is_first_launch?(r.$is_first_time=!0,_.isEmptyObject(n.pre1)||sa.setOnceProfile(n.pre1)):r.$is_first_time=!1,_.isEmptyObject(n.pre2)||sa.registerApp(n.pre2);var i=_.getMPScene(e.scene);i&&(r.$scene=i),_.extend(r,t),sa.para.autoTrack&&sa.para.autoTrack.appLaunch&&sa.track("$MPLaunch",r)},sa.appShow=function(e,t){t&&_.isObject(t)||(t={});var r={};mpshow_time=(new Date).getTime(),e&&e.path&&(r.$url_path=_.getPath(e.path));var n=_.setUtm(e,r);_.isEmptyObject(n.pre2)||sa.registerApp(n.pre2);var i=_.getMPScene(e.scene);i&&(r.$scene=i),_.extend(r,t),sa.para.autoTrack&&sa.para.autoTrack.appShow&&sa.track("$MPShow",r)},sa.appHide=function(e){e&&_.isObject(e)||(e={});var t=(new Date).getTime(),r={};r.$url_path=_.getCurrentPath(),mpshow_time&&t-mpshow_time>0&&(t-mpshow_time)/36e5<24&&(r.event_duration=(t-mpshow_time)/1e3),_.extend(r,e),sa.para.autoTrack&&sa.para.autoTrack.appHide&&sa.track("$MPHide",r)},sa.pageShow=function(e){var t={};t.$url_path=_.getCurrentPath();var r=getCurrentPages(),n=r[r.length-1];try{_.isObject(n)?t.$url_query=n.sensors_mp_url_query?n.sensors_mp_url_query:"":t.$url_query=""}catch(e){logger.info(e)}_.extend(t,e),sa.para.autoTrack&&sa.para.autoTrack.pageShow&&sa.track("$MPViewScreen",t)},sa.pageLoad=function(e,t){if(t&&_.isObject(t)&&_.isObject(e))try{e.sensors_mp_url_query=_.setQuery(t)}catch(e){logger.info(e)}},sa.quick=function(){var e=arguments[0],t=arguments[1],r=arguments[2],n=_.isObject(r)?r:{};"appLaunch"===e||"appShow"===e?t?sa[e](t,n):logger.info("App\u7684launch\u548cshow\uff0c\u5728sensors.quick\u7b2c\u4e8c\u4e2a\u53c2\u6570\u5fc5\u987b\u4f20\u5165App\u7684options\u53c2\u6570"):"appHide"===e&&(n=_.isObject(t)?t:{},sa[e](n))},sa.initial();export default sa;