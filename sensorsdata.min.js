import conf from"./sensorsdata_conf.js";var sa={},_={};sa.para=conf,sa.para.max_string_length=sa.para.max_string_length||200,sa._queue=[],sa.getSystemInfoComplete=!1;var ArrayProto=Array.prototype,FuncProto=Function.prototype,ObjProto=Object.prototype,slice=ArrayProto.slice,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty,LIB_VERSION="1.0.21",LIB_NAME="AlipayMini",source_channel_standard="utm_source utm_medium utm_campaign utm_content utm_term",latest_source_channel=["$latest_utm_source","$latest_utm_medium","$latest_utm_campaign","$latest_utm_content","$latest_utm_term","$latest_sa_utm"],sa_referrer="\u76f4\u63a5\u6253\u5f00";sa.lib_version=LIB_VERSION;var is_first_launch=!1,mpshow_time=null,first_show_page=!1,logger="object"==typeof logger?logger:{};logger.info=function(){if(sa.para.show_log&&"object"==typeof console&&console.log)try{return console.log.apply(console,arguments)}catch(t){console.log(arguments[0])}},function(){FuncProto.bind;var t=ArrayProto.forEach,e=ArrayProto.indexOf,r=Array.isArray,n={},s=_.each=function(e,r,s){if(null==e)return!1;if(t&&e.forEach===t)e.forEach(r,s);else if(e.length===+e.length){for(var i=0,a=e.length;i<a;i++)if(i in e&&r.call(s,e[i],i,e)===n)return!1}else for(var o in e)if(hasOwnProperty.call(e,o)&&r.call(s,e[o],o,e)===n)return!1};_.logger=logger,_.extend=function(t){return s(slice.call(arguments,1),function(e){for(var r in e)void 0!==e[r]&&(t[r]=e[r])}),t},_.extend2Lev=function(t){return s(slice.call(arguments,1),function(e){for(var r in e)void 0!==e[r]&&null!==e[r]&&(_.isObject(e[r])&&_.isObject(t[r])?_.extend(t[r],e[r]):t[r]=e[r])}),t},_.coverExtend=function(t){return s(slice.call(arguments,1),function(e){for(var r in e)void 0!==e[r]&&void 0===t[r]&&(t[r]=e[r])}),t},_.isArray=r||function(t){return"[object Array]"===toString.call(t)},_.isFunction=function(t){try{return/^\s*\bfunction\b/.test(t)}catch(t){return!1}},_.isArguments=function(t){return!(!t||!hasOwnProperty.call(t,"callee"))},_.toArray=function(t){return t?t.toArray?t.toArray():_.isArray(t)?slice.call(t):_.isArguments(t)?slice.call(t):_.values(t):[]},_.values=function(t){var e=[];return null==t?e:(s(t,function(t){e[e.length]=t}),e)},_.include=function(t,r){var i=!1;return null==t?i:e&&t.indexOf===e?-1!=t.indexOf(r):(s(t,function(t){if(i||(i=t===r))return n}),i)}}(),_.trim=function(t){return t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},_.isObject=function(t){return"[object Object]"==toString.call(t)&&null!=t},_.isEmptyObject=function(t){if(_.isObject(t)){for(var e in t)if(hasOwnProperty.call(t,e))return!1;return!0}return!1},_.isUndefined=function(t){return void 0===t},_.isString=function(t){return"[object String]"==toString.call(t)},_.isDate=function(t){return"[object Date]"==toString.call(t)},_.isBoolean=function(t){return"[object Boolean]"==toString.call(t)},_.isNumber=function(t){return"[object Number]"==toString.call(t)&&/[\d\.]+/.test(String(t))},_.isJSONString=function(t){try{JSON.parse(t)}catch(t){return!1}return!0},_.decodeURIComponent=function(t){var e="";try{e=decodeURIComponent(t)}catch(r){e=t}return e},_.encodeDates=function(t){return _.each(t,function(e,r){_.isDate(e)?t[r]=_.formatDate(e):_.isObject(e)&&(t[r]=_.encodeDates(e))}),t},_.formatDate=function(t){function e(t){return t<10?"0"+t:t}return t.getFullYear()+"-"+e(t.getMonth()+1)+"-"+e(t.getDate())+" "+e(t.getHours())+":"+e(t.getMinutes())+":"+e(t.getSeconds())+"."+e(t.getMilliseconds())},_.searchObjDate=function(t){_.isObject(t)&&_.each(t,function(e,r){_.isObject(e)?_.searchObjDate(t[r]):_.isDate(e)&&(t[r]=_.formatDate(e))})},_.formatString=function(t){return t.length>sa.para.max_string_length?(logger.info("\u5b57\u7b26\u4e32\u957f\u5ea6\u8d85\u8fc7\u9650\u5236\uff0c\u5df2\u7ecf\u505a\u622a\u53d6--"+t),t.slice(0,sa.para.max_string_length)):t},_.searchObjString=function(t){_.isObject(t)&&_.each(t,function(e,r){_.isObject(e)?_.searchObjString(t[r]):_.isString(e)&&(t[r]=_.formatString(e))})},_.unique=function(t){for(var e,r=[],n={},s=0;s<t.length;s++)(e=t[s])in n||(n[e]=!0,r.push(e));return r},_.strip_sa_properties=function(t){return _.isObject(t)?(_.each(t,function(e,r){if(_.isArray(e)){var n=[];_.each(e,function(t){_.isString(t)?n.push(t):logger.info("\u60a8\u7684\u6570\u636e-",e,"\u7684\u6570\u7ec4\u91cc\u7684\u503c\u5fc5\u987b\u662f\u5b57\u7b26\u4e32,\u5df2\u7ecf\u5c06\u5176\u5220\u9664")}),0!==n.length?t[r]=n:(delete t[r],logger.info("\u5df2\u7ecf\u5220\u9664\u7a7a\u7684\u6570\u7ec4"))}_.isString(e)||_.isNumber(e)||_.isDate(e)||_.isBoolean(e)||_.isArray(e)||(logger.info("\u60a8\u7684\u6570\u636e-",e,"-\u683c\u5f0f\u4e0d\u6ee1\u8db3\u8981\u6c42\uff0c\u6211\u4eec\u5df2\u7ecf\u5c06\u5176\u5220\u9664"),delete t[r])}),t):t},_.strip_empty_properties=function(t){var e={};return _.each(t,function(t,r){null!=t&&(e[r]=t)}),e},_.utf8Encode=function(t){var e,r,n,s,i="";for(e=r=0,n=(t=(t+"").replace(/\r\n/g,"\n").replace(/\r/g,"\n")).length,s=0;s<n;s++){var a=t.charCodeAt(s),o=null;a<128?r++:o=a>127&&a<2048?String.fromCharCode(a>>6|192,63&a|128):String.fromCharCode(a>>12|224,a>>6&63|128,63&a|128),null!==o&&(r>e&&(i+=t.substring(e,r)),i+=o,e=r=s+1)}return r>e&&(i+=t.substring(e,t.length)),i},_.base64Encode=function(t){var e,r,n,s,i,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o=0,c=0,u="",p=[];if(!t)return t;t=_.utf8Encode(t);do{e=(i=t.charCodeAt(o++)<<16|t.charCodeAt(o++)<<8|t.charCodeAt(o++))>>18&63,r=i>>12&63,n=i>>6&63,s=63&i,p[c++]=a.charAt(e)+a.charAt(r)+a.charAt(n)+a.charAt(s)}while(o<t.length);switch(u=p.join(""),t.length%3){case 1:u=u.slice(0,-2)+"==";break;case 2:u=u.slice(0,-1)+"="}return u},_.info={currentProps:{},properties:{$lib:LIB_NAME,$lib_version:String(LIB_VERSION)},getSystem:function(){var t=this.properties,e=!0;function r(){e&&(e=!0,my.getSystemInfo({success:function(e){var r,n;t.$model=e.model,t.$screen_width=Number(e.screenWidth),t.$screen_height=Number(e.screenHeight),t.$os=(r=e.platform,"ios"===(n=r.toLowerCase())?"iOS":"android"===n?"Android":r),t.$os_version=e.system.indexOf(" ")>-1?e.system.split(" ")[1]:e.system,t.$manufacturer=e.brand},complete:function(){var e,r=(new Date).getTimezoneOffset();my.getAppIdSync&&(e=my.getAppIdSync().appId),e&&(t.$app_id=e),_.isNumber(r)&&(t.$timezone_offset=r),sa.getSystemInfoComplete=!0,sa.checkIsComplete()}}))}my.getNetworkType({success:function(e){t.$network_type=e.networkType,r()},complete:function(){r()}})},setStatusComplete:function(){if(sa.getSystemInfoComplete)return!1;sa.getSystemInfoComplete=!0,sa._queue.length>0&&(_.each(sa._queue,function(t){sa.prepareData.apply(sa,slice.call(t))}),sa._queue=[])}},sa._=_,sa.prepareData=function(t,e){if(!sa.isComplete)return sa._queue.push(arguments),!1;var r={distinct_id:this.store.getDistinctId(),lib:{$lib:LIB_NAME,$lib_method:"code",$lib_version:String(LIB_VERSION)},properties:{}};_.extend(r,t),_.isObject(t.properties)&&!_.isEmptyObject(t.properties)&&_.extend(r.properties,t.properties),t.type&&"profile"===t.type.slice(0,7)||(r._track_id=Number(String(Math.random()).slice(2,5)+String(Math.random()).slice(2,4)+String(Date.now()).slice(-4)),r.properties=_.extend({},_.info.properties,sa.store.getProps(),_.info.currentProps,r.properties),"object"==typeof sa.store._state&&"number"==typeof sa.store._state.first_visit_day_time&&sa.store._state.first_visit_day_time>(new Date).getTime()?r.properties.$is_first_day=!0:r.properties.$is_first_day=!1),r.properties.$time&&_.isDate(r.properties.$time)?(r.time=1*r.properties.$time,delete r.properties.$time):r.time=1*new Date,_.searchObjDate(r),_.searchObjString(r),sa.send(r,e)},sa.checkIsComplete=function(){this.isComplete=!1,this.getSystemInfoComplete&&this.hasInit&&(this.isComplete=!0,sa._queue.length>0&&(_.each(sa._queue,function(t){sa.prepareData.apply(sa,slice.call(t))}),sa._queue=[]))},sa.store={getUUID:function(){return Date.now()+"-"+Math.floor(1e7*Math.random())+"-"+Math.random().toString(16).replace(".","")+"-"+String(31242*Math.random()).replace(".","").slice(0,8)},setStorage:function(){},getStorage:function(){return my.getStorageSync({key:"sensorsdata2015_zfb"})||{}},_state:{},toState:function(t){"object"==typeof t&&t.distinct_id?this._state=t:this.set("distinct_id",this.getUUID())},getFirstId:function(){return this._state.first_id},getDistinctId:function(){return this._state.distinct_id},getProps:function(){return this._state.props||{}},setProps:function(t,e){var r=this._state.props||{};e?this.set("props",t):(_.extend(r,t),this.set("props",r))},set:function(t,e){var r={};for(var n in"string"==typeof t?r[t]=e:"object"==typeof t&&(r=t),this._state=this._state||{},r)this._state[n]=r[n];this.save()},change:function(t,e){this._state[t]=e},save:function(){my.setStorageSync({key:"sensorsdata2015_zfb",data:this._state})},init:function(){var t=this.getStorage().data;if(t)this.toState(t);else{is_first_launch=!0;var e=new Date,r=e.getTime();e.setHours(23),e.setMinutes(59),e.setSeconds(60),sa.setOnceProfile({$first_visit_time:new Date}),this.set({distinct_id:this.getUUID(),first_visit_time:r,first_visit_day_time:e.getTime()})}}},sa.setProfile=function(t,e){sa.prepareData({type:"profile_set",properties:t},e)},sa.setOnceProfile=function(t,e){sa.prepareData({type:"profile_set_once",properties:t},e)},sa.track=function(t,e,r){this.prepareData({type:"track",event:t,properties:e},r)},sa.identify=function(t,e){if("number"==typeof t)t=String(t);else if("string"!=typeof t)return!1;var r=sa.store.getFirstId();!0===e?r?sa.store.set("first_id",t):sa.store.set("distinct_id",t):r?sa.store.change("first_id",t):sa.store.change("distinct_id",t)},sa.trackSignup=function(t,e,r,n){var s=sa.store.getFirstId()||sa.store.getDistinctId();sa.store.set("distinct_id",t),sa.prepareData({original_id:s,distinct_id:t,type:"track_signup",event:e,properties:r},n)},sa.registerApp=function(t){_.isObject(t)&&!_.isEmptyObject(t)&&(_.info.currentProps=_.extend(_.info.currentProps,t))},sa.clearAppRegister=function(t){_.isArray(t)&&_.each(_.info.currentProps,function(e,r){_.include(t,r)&&delete _.info.currentProps[r]})},sa.clearAllRegister=function(){sa.store.setProps({},!0)},sa.login=function(t){var e=sa.store.getFirstId(),r=sa.store.getDistinctId();t!==r&&(e?sa.trackSignup(t,"$SignUp"):(sa.store.set("first_id",r),sa.trackSignup(t,"$SignUp")))},sa.logout=function(t){var e=sa.store.getFirstId();e?(sa.store.set("first_id",""),!0===t?sa.store.set("distinct_id",sa.store.getUUID()):sa.store.set("distinct_id",e)):logger.info("\u6ca1\u6709first_id\uff0clogout\u5931\u8d25")},sa.getAnonymousID=function(){if(!_.isEmptyObject(sa.store._state))return sa.store._state.first_id||sa.store._state.distinct_id;logger.info("\u8bf7\u5148\u521d\u59cb\u5316SDK")},sa.getLocation=function(){my.getSetting({success:function(t){if(!t.authSetting.location)return!1;my.getLocation({success:function(t){sa.registerApp({$latitude:t.latitude*Math.pow(10,6),$longitude:t.longitude*Math.pow(10,6)})},fail:function(t){console.log("\u83b7\u53d6\u4f4d\u7f6e\u5931\u8d25\uff1a",t)}})}})},sa.initial=function(){this._.info.getSystem(),this.store.init(),_.isObject(this.para.register)&&(_.info.properties=_.extend(_.info.properties,this.para.register))},sa.init=function(){if(!0===this.hasInit)return!1;this.hasInit=!0,sa.checkIsComplete()},sa.send=function(t){var e="";t._nocache=(String(Math.random())+String(Math.random())+String(Math.random())).slice(2,15),logger.info(t),t._flush_time=Date.now(),t=JSON.stringify(t),e=-1!==sa.para.server_url.indexOf("?")?sa.para.server_url+"&data="+encodeURIComponent(_.base64Encode(t)):sa.para.server_url+"?data="+encodeURIComponent(_.base64Encode(t));!function(){if(my.canIUse("request"))var t=my.request({url:e,dataType:"text",method:"GET",headers:{"content-type":"application/x-www-form-urlencoded"},complete:function(){r&&clearTimeout(r)}}),r=setTimeout(function(){_.isObject(t)&&_.isFunction(t.abort)&&t.abort()},sa.para.datasend_timeout);else var n=my.httpRequest({url:e,dataType:"text",method:"GET",complete:function(){r&&clearTimeout(s)}}),s=setTimeout(function(){_.isObject(n)&&_.isFunction(n.abort)&&n.abort()},sa.para.datasend_timeout)}()},_.getPath=function(t){return t="string"==typeof t?t.replace(/^\//,""):"\u53d6\u503c\u5f02\u5e38"},_.getQueryParam=function(t,e){var r=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(t);return null===r||r&&"string"!=typeof r[1]&&r[1].length?"":_.decodeURIComponent(r[1])},_.getMPScene=function(t){return"number"==typeof t||"string"==typeof t&&""!==t?t="ali-"+String(t):"\u672a\u53d6\u5230\u503c"},_.getQuery=function(t){var e={};if(t&&_.isObject(t.query)&&(e=_.extend({},t.query),t.query.qrCode&&_.extend(e,_.getObjFromQuery(_.decodeURIComponent(t.query.qrCode)))),t&&_.isObject(t.referrerInfo)&&t.referrerInfo.extraData){var r={};_.isObject(t.referrerInfo.extraData)&&!_.isEmptyObject(t.referrerInfo.extraData)?r=t.referrerInfo.extraData:_.isJSONString(t.referrerInfo.extraData)&&(r=JSON.parse(t.referrerInfo.extraData)),_.extend(e,r)}return e},_.setUtm=function(t,e){var r=_.getQuery(t),n={},s=_.getCustomUtmFromQuery(r,"$","_","$"),i=_.getCustomUtmFromQuery(r,"$latest_","_latest_","$latest_");return n.pre1=s,n.pre2=i,_.extend(e,n.pre1),n},_.getObjFromQuery=function(t){var e=t.split("?"),r={};return e&&e[1]?(_.each(e[1].split("&"),function(t){var e=t.split("=");e[0]&&e[1]&&(r[e[0]]=e[1])}),r):{}},_.getCustomUtmFromQuery=function(t,e,r,n){if(!_.isObject(t))return{};var s={};if(t.sa_utm)for(var i in t)"sa_utm"!==i?_.include(sa.para.source_channel,i)&&(s[r+i]=t[i]):s[n+i]=t[i];else for(var i in t)-1===(" "+source_channel_standard+" ").indexOf(" "+i+" ")?_.include(sa.para.source_channel,i)&&(s[r+i]=t[i]):s[e+i]=t[i];return s},_.existLatestUtm=function(){var t=!1;return _.each(latest_source_channel,function(e,r){_.info.currentProps[e]&&(t=!0)}),t},_.setQuery=function(t){if(t&&_.isObject(t)&&!_.isEmptyObject(t)){var e=[];return _.each(t,function(t,r){"q"===r&&_.isString(t)&&0===t.indexOf("http")||"scene"===r||e.push(r+"="+t)}),e.join("&")}return""},_.setLatestChannel=function(t){_.isEmptyObject(t)||(function(t,e){var r=!1;for(var n in e)t[e[n]]&&(r=!0);return r}(t,latest_source_channel)&&sa.clearAppRegister(latest_source_channel),sa.registerApp(t))},_.getCurrentPath=function(){var t="\u672a\u53d6\u5230";try{var e=getCurrentPages();t=e[e.length-1].route}catch(t){logger.info(t)}return t},sa.appLaunch=function(t,e){e&&_.isObject(e)||(e={});var r={};t&&t.path&&(r.$url_path=_.getPath(t.path));var n=_.setUtm(t,r);is_first_launch?(r.$is_first_time=!0,_.isEmptyObject(n.pre1)||sa.setOnceProfile(n.pre1)):r.$is_first_time=!1,_.isEmptyObject(n.pre2)||_.setLatestChannel(n.pre2);var s=_.getMPScene(t.scene);s&&(r.$scene=s,sa.registerApp({$latest_scene:r.$scene})),_.extend(r,e),sa.para.autoTrack&&sa.para.autoTrack.appLaunch&&sa.track("$MPLaunch",r)},sa.appShow=function(t,e){e&&_.isObject(e)||(e={});var r={};mpshow_time=(new Date).getTime(),first_show_page=!0,t&&t.path&&(r.$url_path=_.getPath(t.path));var n=_.setUtm(t,r);_.isEmptyObject(n.pre2)||_.setLatestChannel(n.pre2),!0===sa.para.preset_properties.location&&sa.getLocation();var s=_.getMPScene(t.scene);s&&(r.$scene=s,sa.registerApp({$latest_scene:r.$scene})),_.extend(r,e),sa.para.autoTrack&&sa.para.autoTrack.appShow&&sa.track("$MPShow",r)},sa.appHide=function(t){t&&_.isObject(t)||(t={});var e=(new Date).getTime(),r={};r.$url_path=_.getCurrentPath(),mpshow_time&&e-mpshow_time>0&&(e-mpshow_time)/36e5<24&&(r.event_duration=(e-mpshow_time)/1e3),_.extend(r,t),sa.para.autoTrack&&sa.para.autoTrack.appHide&&sa.track("$MPHide",r)},sa.pageShow=function(t){var e={},r=_.getCurrentPath();e.$url_path=r;var n=getCurrentPages(),s=n[n.length-1];try{_.isObject(s)?(e.$url_query=s.sensors_mp_url_query?s.sensors_mp_url_query:"",first_show_page&&(first_show_page=!1,!_.existLatestUtm()&&s.utm&&_.isObject(s.utm.pre2)&&sa.registerApp(s.utm.pre2)),s.utm&&_.isObject(s.utm.pre1)&&_.extend(e,s.utm.pre1)):e.$url_query=""}catch(t){logger.info(t)}_.extend(e,t),sa.para.autoTrack&&sa.para.autoTrack.pageShow&&sa.track("$MPViewScreen",e)},sa.pageLoad=function(t,e){if(e&&_.isObject(e)&&_.isObject(t))try{t.sensors_mp_url_query=_.setQuery(e);var r={};r.pre1=_.getCustomUtmFromQuery(e,"$","_","$"),r.pre2=_.getCustomUtmFromQuery(e,"$latest_","_latest_","$latest_"),t.utm=r}catch(t){logger.info(t)}},sa.quick=function(){var t=arguments[0],e=arguments[1],r=arguments[2],n=_.isObject(r)?r:{};"appLaunch"===t||"appShow"===t?e?sa[t](e,n):logger.info("App\u7684launch\u548cshow\uff0c\u5728sensors.quick\u7b2c\u4e8c\u4e2a\u53c2\u6570\u5fc5\u987b\u4f20\u5165App\u7684options\u53c2\u6570"):"appHide"===t&&(n=_.isObject(e)?e:{},sa[t](n))},sa.initial();export default sa;